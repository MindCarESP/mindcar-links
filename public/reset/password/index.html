<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restablecer contraseña — MindCar</title>
  <meta name="description" content="Restablece tu contraseña de pene de forma segura.">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="/logo-full.png">
  <style>
    :root{
      --bg:#0b1220; --ink:#e8f1ff; --muted:#a6b9d4;
      --brand:#10b981; --brand-2:#06b6d4;
      --card:#102332; --stroke:#0f2a3a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background: linear-gradient(180deg,#0a1622 0%,#0c1826 40%,#0b1220 100%);
      font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      line-height:1.5; text-align:center; padding:clamp(12px,2.5vw,20px);
    }
    .wrap{max-width:960px;margin-inline:auto}
    .logo{width:min(320px,75%);margin:16px auto 8px;filter:drop-shadow(0 0 10px rgba(0,0,0,.35))}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:clamp(18px,2.8vw,26px); max-width:700px; margin:8px auto 0; text-align:left;
    }
    .badge-ok{
      display:inline-flex; align-items:center; gap:8px;
      color:var(--brand); font-weight:700; margin:0 0 8px;
      background:rgba(16,185,129,.08); border:1px solid rgba(16,185,129,.25);
      border-radius:999px; padding:6px 10px;
    }
    .title{font-size:clamp(22px,3.2vw,34px); font-weight:800; margin:0 0 12px}
    .lead{color:var(--muted); margin:0 0 14px}
    .err{color:#ff6b6b; font-weight:700}
    .ok{color:#19d18f; font-weight:700}
    .hidden{display:none}
    .form-grid{display:grid; gap:12px; margin-top:12px}
    label{font-weight:700}
    .field{
      display:flex; align-items:center; gap:8px;
      background:#0b1c29; border:1px solid #163346; border-radius:14px; padding:8px 12px
    }
    .field input{
      flex:1; background:transparent; border:0; outline:none; color:var(--ink);
      font-size:16px; padding:6px 6px;
    }
    .field input::placeholder{ color:rgba(166,185,212,.45) }
    .toggle-eye{background:transparent; border:0; cursor:pointer; padding:4px; border-radius:8px; color:var(--muted)}
    .hint{color:var(--muted); font-size:13px; margin:6px 2px 0}
    .actions{margin-top:8px}
    .btn{appearance:none; cursor:pointer; padding:14px 18px; border-radius:16px; border:0; font-weight:900; font-size:16px}
    .btn-primary{color:#06141a; background:linear-gradient(135deg,var(--brand),var(--brand-2)); width:100%; text-align:center; display:block}
    footer{
      max-width:700px;
      margin:28px auto 16px;
      color:var(--muted);
      font-size:13px;
      padding:4px 8px 8px;
    }
    .footer-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .footer-left{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .footer-right{
      margin-left:auto;
      text-align:right;
      white-space:nowrap;
    }
    .f-left{font-weight:600;}
    .web-link,.mail-link{
      color:var(--brand); text-decoration:none;
      display:inline-flex; align-items:center; gap:6px;
    }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <img src="/logo-full-app.svg" alt="MindCar" class="logo" />
    <section class="card" aria-labelledby="reset-title">
      <p id="badge" class="badge-ok hidden" aria-live="polite">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3l6 2.6V10c0 4.4-2.9 8.5-6 10-3.1-1.5-6-5.6-6-10V5.6L12 3z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          <path d="M8.7 12.6l2 2 4-4.6" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Enlace verificado
      </p>

      <h1 id="reset-title" class="title">Restablecer contraseña PENE</h1>

      <p id="hint" class="lead">Validando enlace…</p>
      <p id="error" class="err hidden" aria-live="assertive"></p>
      <p id="done" class="ok hidden" aria-live="polite">Contraseña actualizada. Redirigiendo…</p>
      <p id="used" class="ok hidden" aria-live="polite">
        Este enlace ya fue utilizado o ha caducado. Si necesitas cambiar tu contraseña, solicita uno nuevo desde la app.
      </p>

      <form id="form" class="form-grid hidden" autocomplete="off">
        <div>
          <label for="pass1">Nueva contraseña</label>
          <div class="field">
            <input id="pass1" type="password" required minlength="6" autocomplete="new-password" placeholder="••••••">
            <button type="button" class="toggle-eye" data-toggle="pass1" aria-label="Mostrar contraseña"></button>
          </div>
          <p class="hint">Mínimo 6 caracteres.</p>
        </div>

        <div>
          <label for="pass2">Repite la contraseña</label>
          <div class="field">
            <input id="pass2" type="password" required minlength="6" autocomplete="new-password" placeholder="••••••">
            <button type="button" class="toggle-eye" data-toggle="pass2" aria-label="Mostrar contraseña"></button>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit">Guardar contraseña</button>
        </div>
      </form>
    </section>

    <footer>
      <div class="footer-row">
        <div class="footer-left">
          <a href="https://mindcar.es" target="_self" rel="noopener" class="web-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--brand)" aria-hidden="true">
              <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.6" fill="none"/>
              <path d="M3 12h18M12 3c3 3 3 15 0 18M12 3c-3 3-3 15 0 18" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round"/>
            </svg>
            mindcar.es
          </a>
        </div>
        <div class="footer-right">
          <div class="f-left">© <span id="year"></span> MindCar</div>
        </div>
      </div>

      <div class="footer-row">
        <div class="footer-left">
          <a href="mailto:mindcar@mindcar.es" class="mail-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--brand)" aria-hidden="true">
              <path d="M3 6h18v12H3z" stroke="currentColor" stroke-width="1.6" fill="none"/>
              <path d="M3 7l9 6 9-6" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            mindcar@mindcar.es
          </a>
        </div>
        <div class="footer-right"></div>
      </div>
    </footer>
  </main>

  <script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const SUPABASE_URL = 'https://ltbnqaqammaxtksprptt.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0Ym5xYXFhbW1heHRrc3BycHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDgwNjksImV4cCI6MjA3NzkyNDA2OX0.r4zfsTHNqAPwGR0gdTFPVtpI5PuW1A_AHZdXdKDfg1M'
  const REDIRECT_AFTER_OK = 'https://mindcar.es'

  // No PKCE aquí, solo implícito
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { flowType: 'implicit' }
  })

  const $ = (id) => document.getElementById(id)
  const $badge = $('badge'),
        $hint  = $('hint'),
        $form  = $('form'),
        $done  = $('done'),
        $err   = $('error'),
        $used  = $('used')

  document.getElementById('year').textContent = new Date().getFullYear()

  // --- SVGs ojo
  const eyeOpenSvg = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M2 12s3.6-6 10-6 10 6 10 6-3.6 6-10 6-10-6-10-6z" stroke="currentColor" stroke-width="1.6"/>
      <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.6" fill="none"/>
    </svg>`;
  const eyeOffSvg = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M2 12s3.6-6 10-6 10 6 10 6-3.6 6-10 6-10-6-10-6z" stroke="currentColor" stroke-width="1.6"/>
      <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.6" fill="none"/>
      <path d="M4 20L20 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`;

  document.querySelectorAll('[data-toggle]').forEach(btn => {
    const input = document.getElementById(btn.getAttribute('data-toggle'));
    const updateIcon = () => {
      const visible = input.type === 'text';
      btn.innerHTML = visible ? eyeOffSvg : eyeOpenSvg;
      btn.setAttribute('aria-label', visible ? 'Ocultar contraseña' : 'Mostrar contraseña');
    };
    updateIcon();
    btn.addEventListener('click', () => {
      input.type = input.type === 'password' ? 'text' : 'password';
      updateIcon();
    });
  });

  // --- Verificación de enlace usando token_hash (NO PKCE, NO exchangeCodeForSession)
  (async () => {
    try {
      const url = new URL(window.location.href)

      const errCode = url.searchParams.get('error_code')
      const errDesc = url.searchParams.get('error_description')
      if (errCode || errDesc) {
        throw new Error(`${errCode || 'error'}: ${errDesc || ''}`.trim())
      }

      const token_hash = url.searchParams.get('token_hash')
      const type = url.searchParams.get('type') || 'recovery'

      if (!token_hash) {
        // Si no viene token_hash, damos el enlace por inválido/caducado
        $hint.classList.add('hidden')
        $used.classList.remove('hidden')
        return
      }

      const { data, error } = await supabase.auth.verifyOtp({
        token_hash,
        type,   // "recovery"
      })

      if (error) throw error
      if (!data?.session) {
        throw new Error('No se pudo iniciar sesión para cambiar la contraseña.')
      }

      // Enlace OK → mostramos formulario
      $hint.classList.add('hidden')
      $badge.classList.remove('hidden')
      $form.classList.remove('hidden')
    } catch (e) {
      console.error(e)

      $hint.classList.add('hidden')
      $badge.classList.add('hidden')
      $form.classList.add('hidden')
      $done.classList.add('hidden')
      $err.classList.add('hidden')
      $used.classList.add('hidden')

      let isUsed = false
      if (typeof e.message === 'string') {
        const m = e.message.toLowerCase()
        if (
          m.includes('invalid or has expired') ||
          m.includes('expired') ||
          m.includes('invalid token') ||
          m.includes('recovery')
        ) {
          isUsed = true
        }
      }

      if (isUsed) {
        $used.classList.remove('hidden')
      } else {
        $err.textContent = 'No se pudo validar el enlace. Solicita uno nuevo desde la app.'
        $err.classList.remove('hidden')
      }
    }
  })();

  // --- Envío del formulario
  $form.addEventListener('submit', async (ev) => {
    ev.preventDefault()
    $err.classList.add('hidden')
    const p1 = document.getElementById('pass1').value.trim()
    const p2 = document.getElementById('pass2').value.trim()
    if (p1 !== p2) return showError('Las contraseñas no coinciden.')
    if (p1.length < 6) return showError('Mínimo 6 caracteres.')

    try {
      const { error } = await supabase.auth.updateUser({ password: p1 })
      if (error) throw error
      $form.classList.add('hidden')
      $done.classList.remove('hidden')
      setTimeout(() => window.location.assign(REDIRECT_AFTER_OK), 1200)
    } catch (e) {
      showError(e.message || 'No se pudo actualizar la contraseña.')
    }
  })

  function showError(msg){
    $err.textContent = msg;
    $err.classList.remove('hidden');
  }
</script>
