<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MindCar ‚Äî Restablecer contrase√±a</title>
  <meta name="description" content="Restablece tu contrase√±a de MindCar de forma segura.">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="/logo-full.png">
  <style>
    :root{
      --bg:#0b1220; --ink:#e8f1ff; --muted:#a6b9d4;
      --brand:#10b981; --brand-2:#06b6d4;
      --card:#102332; --stroke:#0f2a3a;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background: linear-gradient(180deg,#0a1622 0%,#0c1826 40%,#0b1220 100%);
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      line-height:1.5; text-align:center; padding:clamp(16px,3vw,24px);
    }
    .wrap{max-width:960px;margin-inline:auto}
    .logo{width:min(320px,75%);margin:40px auto 20px;filter:drop-shadow(0 0 10px rgba(0,0,0,.35))}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:clamp(20px,3vw,28px); max-width:700px; margin:10px auto 0; text-align:left;
    }
    .title{font-size:clamp(22px,3.2vw,34px); font-weight:800; margin:0 0 6px}
    .lead{color:var(--muted); margin:0 0 16px}
    .err{color:#ff6b6b; font-weight:700}
    .ok{color:#19d18f; font-weight:700}
    .hidden{display:none}
    .form-grid{display:grid; gap:12px; margin-top:10px}
    label{font-weight:700}
    .field{display:flex; align-items:center; gap:8px; background:#0b1c29; border:1px solid #163346; border-radius:14px; padding:8px 12px}
    .field input{flex:1; background:transparent; border:0; outline:none; color:var(--ink); font-size:16px; padding:6px 6px}
    .field button{background:transparent; border:0; color:var(--muted); cursor:pointer; padding:6px; border-radius:8px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:6px}
    .btn{appearance:none; cursor:pointer; padding:14px 18px; border-radius:16px; border:0; font-weight:900; font-size:16px}
    .btn-primary{color:#06141a; background:linear-gradient(135deg,var(--brand),var(--brand-2))}
    .btn-ghost{color:var(--ink); background:transparent; border:1px solid var(--stroke)}
    footer{max-width:700px; margin:28px auto 8px; color:var(--muted); font-size:13px; display:flex; justify-content:space-between; align-items:center; padding:0 8px}
    footer a{color:var(--brand); text-decoration:none}
    @media (prefers-reduced-motion: reduce){.btn{transition:none}}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <img src="/logo-full-app.svg" alt="MindCar" class="logo" />
    <section class="card" aria-labelledby="reset-title">
      <h1 id="reset-title" class="title">Restablecer contrase√±a <span style="color:var(--brand)">MindCar</span></h1>
      <p id="status" class="lead" aria-live="polite">Validando enlace‚Ä¶</p>
      <p id="error" class="err hidden" aria-live="assertive"></p>
      <p id="done" class="ok hidden" aria-live="polite">Contrase√±a actualizada. Redirigiendo‚Ä¶</p>

      <form id="form" class="form-grid hidden" autocomplete="off">
        <div>
          <label for="pass1">Nueva contrase√±a</label>
          <div class="field">
            <input id="pass1" type="password" required minlength="6" autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button type="button" data-toggle="pass1" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
          </div>
        </div>

        <div>
          <label for="pass2">Repite la contrase√±a</label>
          <div class="field">
            <input id="pass2" type="password" required minlength="6" autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button type="button" data-toggle="pass2" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit">Guardar contrase√±a</button>
          <a class="btn btn-ghost" href="https://mindcar.es">Volver a MindCar</a>
        </div>
        <p class="lead" style="margin:8px 0 0;">M√≠nimo 8 caracteres. No compartas este enlace.</p>
      </form>
    </section>

    <footer>
      <div>¬© <span id="year"></span> MindCar</div>
      <div><a href="mailto:mindcar@mindcar.es">‚úâÔ∏è mindcar@mindcar.es</a></div>
    </footer>
  </main>

  <!-- JS: versi√≥n simple y a prueba de bombas -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // üîß Config
    const SUPABASE_URL = 'https://ltbnqaqammaxtksprptt.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0Ym5xYXFhbW1heHRrc3BycHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDgwNjksImV4cCI6MjA3NzkyNDA2OX0.r4zfsTHNqAPwGR0gdTFPVtpI5PuW1A_AHZdXdKDfg1M'
    const REDIRECT_AFTER_OK = 'https://mindcar.es'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { flowType: 'implicit' } // reset cross-device
    })

    const $ = (id) => document.getElementById(id)
    const $status = $('status'), $form = $('form'), $done = $('done'), $err = $('error')
    $('year').textContent = new Date().getFullYear()

    // Toggle üëÅÔ∏è
    document.querySelectorAll('[data-toggle]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-toggle')
        const input = document.getElementById(id)
        input.type = input.type === 'password' ? 'text' : 'password'
      })
    })

    // 1) Intenta sesi√≥n por hash (Implicit). Si no, intenta intercambio por ?code (PKCE).
    ;(async () => {
      try {
        // Si el proveedor devolvi√≥ error expl√≠cito en la URL, muestralo
        const url = new URL(window.location.href)
        const errCode = url.searchParams.get('error_code') || new URLSearchParams(url.hash.slice(1)).get('error_code')
        const errDesc = url.searchParams.get('error_description') || new URLSearchParams(url.hash.slice(1)).get('error_description')
        if (errCode || errDesc) throw new Error(`${errCode || 'error'}: ${errDesc || ''}`.trim())

        let { data: { session } } = await supabase.auth.getSession()

        if (!session) {
          // Soporte PKCE por si alguien llega con ?code=...
          const { error } = await supabase.auth.exchangeCodeForSession(window.location.href)
          if (error) throw error
          ;({ data: { session } } = await supabase.auth.getSession())
        }

        if (!session) throw new Error('Enlace de recuperaci√≥n no v√°lido o caducado.')

        $status.textContent = 'Enlace verificado. Elige tu nueva contrase√±a.'
        $form.classList.remove('hidden')
      } catch (e) {
        $status.classList.add('hidden')
        $err.textContent = e.message || 'No se pudo validar el enlace.'
        $err.classList.remove('hidden')
      }
    })()

    // 2) Cambiar contrase√±a
    $form.addEventListener('submit', async (ev) => {
      ev.preventDefault()
      $err.classList.add('hidden')

      const p1 = $('pass1').value.trim()
      const p2 = $('pass2').value.trim()
      if (p1 !== p2) return showError('Las contrase√±as no coinciden.')
      if (p1.length < 8) return showError('M√≠nimo 8 caracteres.')

      try {
        const { error } = await supabase.auth.updateUser({ password: p1 })
        if (error) throw error
        $form.classList.add('hidden')
        $done.classList.remove('hidden')
        setTimeout(() => window.location.assign(REDIRECT_AFTER_OK), 1200)
      } catch (e) {
        showError(e.message || 'No se pudo actualizar la contrase√±a.')
      }
    })

    function showError(msg){ $err.textContent = msg; $err.classList.remove('hidden') }
  </script>
</body>
</html>
