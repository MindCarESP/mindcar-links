<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const SUPABASE_URL = 'https://ltbnqaqammaxtksprptt.supabase.co'
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0Ym5xYXFhbW1heHRrc3BycHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDgwNjksImV4cCI6MjA3NzkyNDA2OX0.r4zfsTHNqAPwGR0gdTFPVtpI5PuW1A_AHZdXdKDfg1M'
  const REDIRECT_AFTER_OK = 'https://mindcar.es'

  // 游녢 Volvemos al flujo normal (impl칤cito)
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { flowType: 'implicit' }
  })

  const $ = (id) => document.getElementById(id)
  const $badge = $('badge'),
        $hint  = $('hint'),
        $form  = $('form'),
        $done  = $('done'),
        $err   = $('error'),
        $used  = $('used')

  document.getElementById('year').textContent = new Date().getFullYear()

  // --- SVGs para el icono del ojo
  const eyeOpenSvg = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M2 12s3.6-6 10-6 10 6 10 6-3.6 6-10 6-10-6-10-6z" stroke="currentColor" stroke-width="1.6"/>
      <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.6" fill="none"/>
    </svg>`;
  const eyeOffSvg = `
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M2 12s3.6-6 10-6 10 6 10 6-3.6 6-10 6-10-6-10-6z" stroke="currentColor" stroke-width="1.6"/>
      <circle cx="12" cy="12" r="3.2" stroke="currentColor" stroke-width="1.6" fill="none"/>
      <path d="M4 20L20 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>`;

  // --- Toggle del ojo con cambio de icono din치mico
  document.querySelectorAll('[data-toggle]').forEach(btn => {
    const input = document.getElementById(btn.getAttribute('data-toggle'));
    const updateIcon = () => {
      const visible = input.type === 'text';
      btn.innerHTML = visible ? eyeOffSvg : eyeOpenSvg;
      btn.setAttribute('aria-label', visible ? 'Ocultar contrase침a' : 'Mostrar contrase침a');
    };
    updateIcon();
    btn.addEventListener('click', () => {
      input.type = input.type === 'password' ? 'text' : 'password';
      updateIcon();
    });
  });

  // --- Verificaci칩n del enlace (simple, sin exchangeCodeForSession)
  (async () => {
    try {
      const url = new URL(window.location.href)
      const hashParams = new URLSearchParams(url.hash.slice(1))

      const errCode = url.searchParams.get('error_code') || hashParams.get('error_code')
      const errDesc = url.searchParams.get('error_description') || hashParams.get('error_description')

      if (errCode || errDesc) {
        // Si Supabase ya indica error en la URL, damos el enlace por caducado/usado
        $hint.classList.add('hidden')
        $used.classList.remove('hidden')
        return
      }

      // Supabase-js, con flowType implicit, ya habr치 intentado leer el token de la URL
      const { data: { session } } = await supabase.auth.getSession()

      if (!session) {
        // No hay sesi칩n -> enlace no v치lido / ya usado
        $hint.classList.add('hidden')
        $used.classList.remove('hidden')
        return
      }

      // Todo OK, mostramos el formulario
      $hint.classList.add('hidden')
      $badge.classList.remove('hidden')
      $form.classList.remove('hidden')
    } catch (e) {
      console.error(e)
      $hint.classList.add('hidden')
      $err.textContent = 'No se pudo validar el enlace. Solicita uno nuevo desde la app.'
      $err.classList.remove('hidden')
    }
  })();

  // --- Env칤o del formulario
  $form.addEventListener('submit', async (ev) => {
    ev.preventDefault()
    $err.classList.add('hidden')

    const p1 = document.getElementById('pass1').value.trim()
    const p2 = document.getElementById('pass2').value.trim()

    if (p1 !== p2) return showError('Las contrase침as no coinciden.')
    if (p1.length < 6) return showError('M칤nimo 6 caracteres.')

    try {
      const { error } = await supabase.auth.updateUser({ password: p1 })

      if (error) {
        const msg = (error.message || '').toLowerCase()

        // Enlace caducado / sin sesi칩n -> lo tratamos como "ya fue usado"
        if (msg.includes('auth session missing') || msg.includes('no access token')) {
          $form.classList.add('hidden')
          $done.classList.add('hidden')
          $used.classList.remove('hidden')
          return
        }

        throw error
      }

      $form.classList.add('hidden')
      $done.classList.remove('hidden')
      setTimeout(() => window.location.assign(REDIRECT_AFTER_OK), 1200)
    } catch (e) {
      showError(e.message || 'No se pudo actualizar la contrase침a.')
    }
  })

  function showError(msg){
    $err.textContent = msg;
    $err.classList.remove('hidden');
  }
</script>
