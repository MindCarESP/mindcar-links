<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const client = supabase.createClient("https://TU-PROJECT-URL.supabase.co", "TU-ANON-PUBLIC-KEY");

  // 1️⃣ Leer el code que viene en la URL
  const url = new URL(window.location.href);
  const code = url.searchParams.get('code');
  const type = url.searchParams.get('type');

  async function ensureSession() {
    if (!code) return false;
    try {
      // 2️⃣ Convertir el code en sesión válida
      const { data, error } = await client.auth.exchangeCodeForSession(code);
      return !error;
    } catch (_) {
      return false;
    }
  }

  // 3️⃣ Solo permitir cambiar contraseña si ya se generó sesión
  const btn = document.getElementById("submit");
  const status = document.getElementById("status");

  btn.onclick = async () => {
    const password = document.getElementById("newPass").value.trim();
    if (password.length < 6) {
      status.textContent = "La contraseña debe tener mínimo 6 caracteres.";
      status.style.color = "red";
      return;
    }

    btn.disabled = true;
    status.textContent = "Actualizando contraseña...";
    status.style.color = "#aaa";

    // 4️⃣ Garantizar sesión primero
    const ok = await ensureSession();
    if (!ok) {
      status.textContent = "Error: Auth session missing";
      status.style.color = "red";
      btn.disabled = false;
      return;
    }

    // 5️⃣ Ahora sí: cambiar contraseña
    const { error } = await client.auth.updateUser({ password });
    if (error) {
      status.textContent = "Error: " + error.message;
      status.style.color = "red";
      btn.disabled = false;
      return;
    }

    status.textContent = "Contraseña cambiada correctamente. Ahora puedes iniciar sesión.";
    status.style.color = "green";
  };
</script>
