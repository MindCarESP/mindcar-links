<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://ltbnqaqammaxtksprptt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0Ym5xYXFhbW1heHRrc3BycHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDgwNjksImV4cCI6MjA3NzkyNDA2OX0.r4zfsTHNqAPwGR0gdTFPVtpI5PuW1A_AHZdXdKDfg1M";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form        = document.getElementById("reset-form");
  const input       = document.getElementById("newPass");
  const statusEl    = document.getElementById("status");
  const btn         = document.getElementById("submit");
  const btnText     = document.getElementById("btn-text");
  const btnSpinner  = document.getElementById("btn-spinner");

  function setStatus(msg, type = "") {
    statusEl.textContent = msg || "";
    statusEl.className = "status" + (type ? " " + type : "");
  }

  function setLoading(isLoading) {
    btn.disabled = isLoading;
    btnSpinner.style.display = isLoading ? "inline-block" : "none";
    btnText.textContent = isLoading ? "Actualizando..." : "Cambiar contraseña";
  }

  async function ensureSession() {
    const url = new URL(window.location.href);
    const hash = window.location.hash || "";

    // 1) Enlace claramente inválido / caducado (Supabase pone esto en el hash)
    if (hash.includes("error=")) {
      console.error("Supabase error in URL hash:", hash);
      setStatus("El enlace no es válido o ha expirado. Pide otro desde la app.", "error");
      return false;
    }

    // 2) Por si Supabase ya ha procesado tokens (access_token en hash, etc.)
    try {
      const { data, error } = await supa.auth.getSession();
      if (error) {
        console.error("getSession error:", error);
      } else if (data && data.session) {
        // Ya hay sesión válida -> todo OK
        return true;
      }
    } catch (err) {
      console.error("getSession exception:", err);
    }

    // 3) Flujo PKCE: buscar ?code=... en la URL
    const code = url.searchParams.get("code");
    if (!code) {
      setStatus("Enlace inválido o incompleto (falta el código de recuperación).", "error");
      return false;
    }

    try {
      const { data, error } = await supa.auth.exchangeCodeForSession(code);
      if (error) {
        console.error("exchangeCodeForSession error:", error);
        setStatus("El enlace no es válido o ha expirado. Pide otro desde la app.", "error");
        return false;
      }

      // Ya tenemos sesión
      return true;
    } catch (err) {
      console.error("exchangeCodeForSession exception:", err);
      setStatus("No se pudo validar el enlace de recuperación.", "error");
      return false;
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    setLoading(true);
    const ok = await ensureSession();
    if (!ok) {
      btn.disabled = true;
    }
    setLoading(false);
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const password = input.value.trim();

    if (password.length < 6) {
      setStatus("La contraseña debe tener al menos 6 caracteres.", "error");
      return;
    }

    setLoading(true);
    setStatus("Actualizando contraseña...");

    try {
      const { error } = await supa.auth.updateUser({ password });
      if (error) {
        console.error("updateUser error:", error);
        setStatus("Error: " + error.message, "error");
        return;
      }

      setStatus(
        "Contraseña cambiada correctamente. Ya puedes iniciar sesión en la app.",
        "ok"
      );
    } catch (err) {
      console.error("updateUser exception:", err);
      setStatus("No se pudo cambiar la contraseña. Inténtalo de nuevo.", "error");
    } finally {
      setLoading(false);
    }
  });
</script>
